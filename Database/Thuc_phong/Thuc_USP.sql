use QuanLyCauHoiTracNghiem
go

IF OBJECT_ID('SP_GVQLCAPQUYEN', 'P') IS NOT NULL
	DROP PROC SP_GVQLCAPQUYEN
GO

CREATE PROC SP_GVQLCAPQUYEN
	@MAGVQL BIGINT,
	@MAGV BIGINT,
	@KETQUA BIT
AS
BEGIN
	BEGIN TRAN
		BEGIN TRY
			DECLARE @COUNT INT = (SELECT COUNT(ND.MALOAI)
									FROM NGUOIDUNG ND
									WHERE ND.MAND = @MAGVQL AND
											ND.MALOAI = 1)

			DECLARE @CUNGBM BIT = (SELECT 1
									FROM NGUOIDUNG ND1, NGUOIDUNG ND2
									WHERE ND1.MAND = @MAGV AND
											ND2.MAND = @MAGVQL AND
											ND1.MABM = ND2.MABM)

			IF @COUNT = 0 OR @CUNGBM != 1
			BEGIN
				SET @KETQUA = 0
				RETURN
			END

			IF @COUNT = 1 AND @CUNGBM = 1
			BEGIN
				UPDATE NGUOIDUNG
				SET TOANQUYENGV = 1
				WHERE MAND = @MAGV

				SET @KETQUA = 1
				RETURN
			END
		END TRY
		BEGIN CATCH
			ROLLBACK TRAN
			SET @KETQUA = 0
		END CATCH
	COMMIT TRAN
END
GO