CREATE PROC sp_TaoTaiKhoan
@HoTen nvarchar(255),
@TenDangNhap varchar(30),
@MatKhau varchar(30),
@TrangThai bit,
@ToanQuyenGV bit,
@MaLoai bigint,
@MaBM bigint,
@MaGVQL bigint
AS 
BEGIN TRAN
	BEGIN TRY
		IF NOT EXISTS(SELECT * FROM LOAINGUOIDUNG WHERE [MALOAI] = @MaLoai)
			BEGIN
				PRINT N'MA LOAI NGUOI DUNG KHONG TON TAI'
				ROLLBACK TRAN
				RETURN 1
			END
		IF NOT EXISTS(SELECT * FROM BOMON WHERE [MABM] = @MaBM)
			BEGIN
				PRINT N'MA BO MON KHONG TON TAI'
				ROLLBACK TRAN
				RETURN 2
			END
		IF NOT EXISTS(SELECT * FROM NGUOIDUNG WHERE [MAND] = @MaGVQL)
			BEGIN
				PRINT N'MA GIAO VIEN QUAN LY KHONG TON TAI'
				ROLLBACK TRAN
				RETURN 3
			END
		WAITFOR DELAY '00:00:10'
		INSERT INTO [NGUOIDUNG] 
				([HOTEN],
				[TENDANGNHAP],
				[MATKHAU],
				[TRANGTHAI],
				[TOANQUYENGV],
				[MALOAI],
				[MABM],
				[MAGVQL])
		VALUES (@HoTen,
				@TenDangNhap,
				@MatKhau,
				@TrangThai,
				@ToanQuyenGV,
				@MaLoai,
				@MaBM,
				@MaGVQL)
	END TRY
	BEGIN CATCH
		PRINT N'LOI HE THONG'
		ROLLBACK TRAN
		RETURN 1
	END CATCH
COMMIT TRAN
RETURN 0
GO

CREATE PROC sp_XoaBoMon
@MaBM bigint,
@Return int out
AS
SET TRAN ISOLATION LEVEL SERIALIZABLE
BEGIN TRAN
	BEGIN TRY
		SET @Return = 0
		IF NOT EXISTS(SELECT * FROM BOMON WHERE [MABM] = @MaBM)
			BEGIN
				PRINT N'MA BO MON KHONG TON TAI'
				SET @Return = 1
			END
		ELSE IF EXISTS(SELECT * FROM NGUOIDUNG WHERE [MABM] = @MaBM)
			BEGIN
				PRINT N'BO MON DA DUOC SU DUNG. KHONG THE XOA DUOC'
				SET @Return = 2
			END
		IF @Return = 0
			BEGIN
				DELETE BOMON WHERE [MABM] = @MaBM
			END
	END TRY
	BEGIN CATCH
		PRINT N'LOI HE THONG'
		SET @Return = 3
		ROLLBACK TRAN		
		RETURN 1
	END CATCH
COMMIT TRAN
RETURN 0
GO